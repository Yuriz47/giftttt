<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿ƒæ„ç›²ç›’ - çŒœçŒœæˆ‘è¦é€ä½ ä»€ä¹ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink: #FF6B9D;
            --blue: #4ECDC4;
            --dark: #2D3436;
            --cream: #FFF5F5;
        }
        
        * {
            font-family: 'Noto Sans SC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #FFEEF8 0%, #E8F8F5 100%);
            overflow-x: hidden;
        }
        
        .hand-drawn {
            border: 3px solid var(--dark);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 4px 4px 0px rgba(45, 52, 54, 0.1);
        }
        
        .hand-drawn-pink {
            border: 3px solid var(--pink);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
        }
        
        .hand-drawn-blue {
            border: 3px solid var(--blue);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(1deg); }
        }
        
        @keyframes float-delayed {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(-1deg); }
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }
        
        .float-anim {
            animation: float 4s ease-in-out infinite;
        }
        
        .float-anim-delayed {
            animation: float-delayed 5s ease-in-out infinite;
            animation-delay: 1s;
        }
        
        .wiggle-anim {
            animation: wiggle 3s ease-in-out infinite;
        }
        
        .btn-press:active {
            transform: scale(0.95) translateY(2px);
            box-shadow: 2px 2px 0px rgba(45, 52, 54, 0.1);
        }
        
        .parallax-bg {
            position: fixed;
            pointer-events: none;
            z-index: -1;
            opacity: 0.6;
        }
        
        .option-card {
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            cursor: pointer;
        }
        
        .option-card:hover {
            transform: translateY(-5px) rotate(1deg);
            box-shadow: 6px 6px 0px rgba(255, 107, 157, 0.3);
        }
        
        .option-card.selected {
            background: linear-gradient(135deg, #FFEEF8 0%, #FFF0F5 100%);
            border-color: var(--pink);
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(255, 107, 157, 0.2);
        }
        
        .doodle {
            position: absolute;
            pointer-events: none;
        }
        
        .code-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: 900;
            border: 3px solid var(--dark);
            border-radius: 12px;
            background: white;
            margin: 0 4px;
            transition: all 0.2s;
        }
        
        .code-input:focus {
            border-color: var(--pink);
            transform: scale(1.1);
            outline: none;
            box-shadow: 0 0 0 4px rgba(255, 107, 157, 0.2);
        }
        
        .tab-active {
            background: var(--pink);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 0 rgba(255, 107, 157, 0.3);
        }
        
        @keyframes popIn {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            70% { transform: scale(1.1) rotate(3deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .result-pop {
            animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--pink);
            border-radius: 10px;
        }
        
        .feedback-tag {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .feedback-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        
        .feedback-tag.selected {
            background: var(--blue);
            color: white;
            transform: scale(1.05);
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        .star {
            animation: twinkle 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .loading-dot {
            animation: bounce 0.6s ease-in-out infinite;
        }
        
        .loading-dot:nth-child(2) { animation-delay: 0.1s; }
        .loading-dot:nth-child(3) { animation-delay: 0.2s; }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .tag-pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }

        .price-tag {
            background: linear-gradient(135deg, #FFEEF8 0%, #FFF0F5 100%);
            color: #FF6B9D;
            border: 2px solid #FF6B9D;
        }

        .feature-tag {
            background: linear-gradient(135deg, #E8F8F5 0%, #F0F9FF 100%);
            color: #4ECDC4;
            border: 2px solid #4ECDC4;
        }

        .match-tag {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5E6 100%);
            color: #FF9F43;
            border: 2px solid #FF9F43;
        }

        .share-btn {
            transition: all 0.3s;
        }
        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(45, 52, 54, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
            transition: all 0.3s;
        }
        .sync-status.online {
            background: #4ECDC4;
            color: white;
        }
        .sync-status.offline {
            background: #FF6B9D;
            color: white;
        }
        .sync-status.syncing {
            background: #FFD93D;
            color: #333;
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen relative">

    <!-- åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="sync-status" class="sync-status offline">ç¦»çº¿æ¨¡å¼</div>

    <div class="parallax-bg top-20 left-10 text-6xl float-anim" data-speed="0.5">âœ¨</div>
    <div class="parallax-bg top-40 right-20 text-4xl float-anim-delayed" data-speed="0.3">ğŸ</div>
    <div class="parallax-bg bottom-40 left-20 text-5xl wiggle-anim" data-speed="0.7">ğŸ¦‹</div>
    <div class="parallax-bg top-60 left-1/2 text-3xl float-anim" data-speed="0.4" style="animation-delay: 2s">â­</div>
    <div class="parallax-bg bottom-20 right-10 text-6xl float-anim-delayed" data-speed="0.6">ğŸŒ¸</div>

    <div id="toast" class="toast"></div>

    <div id="app" class="max-w-md mx-auto min-h-screen p-4 pb-20 relative z-10">
        
        <header class="text-center mb-8 pt-8">
            <div class="inline-block relative">
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-blue-400 float-anim" style="filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.1));">
                    å¿ƒæ„ç›²ç›’
                </h1>
                <div class="absolute -top-4 -right-8 text-2xl star">ğŸ’</div>
                <div class="absolute -bottom-2 -left-6 text-xl star" style="animation-delay: 0.5s">âœ¨</div>
            </div>
            <p class="mt-2 text-gray-600 font-bold text-sm tracking-widest">GIFT MYSTERY BOX</p>
        </header>

        <main id="main-content"></main>

    </div>

    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t-4 border-pink-300 p-4 z-50 hidden">
        <div class="max-w-md mx-auto flex justify-around">
            <button onclick="showHome()" class="flex flex-col items-center gap-1 text-gray-400 hover:text-pink-500 transition-colors">
                <span class="text-2xl">ğŸ </span>
                <span class="text-xs font-bold">é¦–é¡µ</span>
            </button>
            <button onclick="showMyRooms()" class="flex flex-col items-center gap-1 text-gray-400 hover:text-pink-500 transition-colors">
                <span class="text-2xl">ğŸ</span>
                <span class="text-xs font-bold">æˆ‘çš„æˆ¿é—´</span>
            </button>
            <button onclick="showCreateRoom()" class="flex flex-col items-center gap-1 text-gray-400 hover:text-pink-500 transition-colors">
                <span class="text-2xl">âœ¨</span>
                <span class="text-xs font-bold">åˆ›å»º</span>
            </button>
        </div>
    </nav>

    <script>
        // ==================== Firebase é…ç½® ====================
        // è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Firebase é…ç½®
       const firebaseConfig = {
  apiKey: "AIzaSyBpIT_Giv-SgHYWXUS0Gq35bwf1Z4Te3XA",
  authDomain: "giftttt-b846a.firebaseapp.com",
  databaseURL: "https://giftttt-b846a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "giftttt-b846a",
  storageBucket: "giftttt-b846a.firebasestorage.app",
  messagingSenderId: "256749290824",
  appId: "1:256749290824:web:ac37aae0b6742186dd9f7d",
  measurementId: "G-PKET9NYP3D"
};

        // åˆå§‹åŒ– Firebase
        let db;
        let isOnline = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            isOnline = true;
            updateSyncStatus('online');
        } catch (e) {
            console.error('Firebase åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼', e);
            updateSyncStatus('offline');
        }

        function updateSyncStatus(status) {
            const el = document.getElementById('sync-status');
            el.className = 'sync-status ' + status;
            if (status === 'online') el.textContent = 'å®æ—¶åŒæ­¥ä¸­';
            else if (status === 'offline') el.textContent = 'ç¦»çº¿æ¨¡å¼';
            else if (status === 'syncing') el.textContent = 'åŒæ­¥ä¸­...';
        }

        // ==================== æ•°æ®å­˜å‚¨å±‚ ====================
        const DataStore = {
            // æœ¬åœ°ç¼“å­˜
            localRooms: JSON.parse(localStorage.getItem('giftRooms') || '[]'),
            currentRoom: null,

            // ä¿å­˜æˆ¿é—´åˆ°äº‘ç«¯å’Œæœ¬åœ°
            async saveRoom(room) {
                // æœ¬åœ°ä¿å­˜
                const existingIndex = this.localRooms.findIndex(r => r.code === room.code);
                if (existingIndex >= 0) {
                    this.localRooms[existingIndex] = room;
                } else {
                    this.localRooms.push(room);
                }
                localStorage.setItem('giftRooms', JSON.stringify(this.localRooms));

                // äº‘ç«¯ä¿å­˜
                if (isOnline && db) {
                    try {
                        updateSyncStatus('syncing');
                        await db.ref('rooms/' + room.code).set({
                            ...room,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        });
                        updateSyncStatus('online');
                    } catch (e) {
                        console.error('äº‘ç«¯ä¿å­˜å¤±è´¥', e);
                        updateSyncStatus('offline');
                    }
                }

                return room;
            },

            // ä»äº‘ç«¯è·å–æˆ¿é—´
            async getRoom(code) {
                // å…ˆæŸ¥æœ¬åœ°
                const localRoom = this.localRooms.find(r => r.code === code);
                
                // å¦‚æœåœ¨çº¿ï¼Œä»äº‘ç«¯è·å–æœ€æ–°
                if (isOnline && db) {
                    try {
                        updateSyncStatus('syncing');
                        const snapshot = await db.ref('rooms/' + code).once('value');
                        updateSyncStatus('online');
                        
                        if (snapshot.exists()) {
                            const cloudRoom = snapshot.val();
                            // åˆå¹¶äº‘ç«¯æ•°æ®åˆ°æœ¬åœ°
                            const mergedRoom = { ...localRoom, ...cloudRoom };
                            // æ›´æ–°æœ¬åœ°ç¼“å­˜
                            const idx = this.localRooms.findIndex(r => r.code === code);
                            if (idx >= 0) this.localRooms[idx] = mergedRoom;
                            else this.localRooms.push(mergedRoom);
                            localStorage.setItem('giftRooms', JSON.stringify(this.localRooms));
                            return mergedRoom;
                        }
                    } catch (e) {
                        console.error('äº‘ç«¯è·å–å¤±è´¥', e);
                        updateSyncStatus('offline');
                    }
                }

                return localRoom || null;
            },

            // æ·»åŠ çŒœæµ‹è®°å½•
            async addGuess(code, guess) {
                const room = await this.getRoom(code);
                if (!room) return null;

                if (!room.guesses) room.guesses = [];
                room.guesses.push({
                    ...guess,
                    timestamp: Date.now(),
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                });

                return await this.saveRoom(room);
            },

            // å®æ—¶ç›‘å¬æˆ¿é—´å˜åŒ–
            listenToRoom(code, callback) {
                if (isOnline && db) {
                    db.ref('rooms/' + code).on('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const room = snapshot.val();
                            callback(room);
                        }
                    });
                }
            },

            // è·å–æˆ‘çš„æ‰€æœ‰æˆ¿é—´ï¼ˆåˆå¹¶äº‘ç«¯å’Œæœ¬åœ°ï¼‰
            async getMyRooms() {
                // å¦‚æœåœ¨çº¿ï¼Œå°è¯•åŒæ­¥æ‰€æœ‰æœ¬åœ°æˆ¿é—´åˆ°äº‘ç«¯
                if (isOnline && db) {
                    for (const room of this.localRooms) {
                        try {
                            const snapshot = await db.ref('rooms/' + room.code).once('value');
                            if (!snapshot.exists()) {
                                // äº‘ç«¯æ²¡æœ‰ï¼Œä¸Šä¼ æœ¬åœ°æˆ¿é—´
                                await db.ref('rooms/' + room.code).set(room);
                            }
                        } catch (e) {
                            console.error('åŒæ­¥æˆ¿é—´å¤±è´¥', e);
                        }
                    }
                }
                return this.localRooms;
            },

            // åˆ‡æ¢æˆ¿é—´çŠ¶æ€
            async toggleRoomStatus(code) {
                const room = await this.getRoom(code);
                if (!room) return null;
                
                room.status = room.status === 'active' ? 'closed' : 'active';
                return await this.saveRoom(room);
            }
        };

        // ==================== ç¤¼ç‰©æ•°æ®åº“ï¼ˆä¿æŒä¹‹å‰çš„å†…å®¹ï¼‰====================
        const giftDatabase = {
            coffee: {
                low: [
                    { name: " origami æŠ˜çº¸æ»¤æ¯", desc: "æ—¥æœ¬é™¶ç“·æ»¤æ¯ï¼Œæµé€Ÿé€‚ä¸­é€‚åˆæ–°æ‰‹ï¼Œæ­é…TAå–œæ¬¢çš„æµ…çƒ˜è±†èƒ½å†²å‡ºèŠ±æœé¦™", tags: ["æ‰‹å†²å…¥é—¨", "é¢œå€¼åœ¨çº¿"], match: "å’–å•¡å™¨å…·" },
                    { name: "å’–å•¡é—»é¦™ç“¶", desc: "36å‘³å’–å•¡é¦™æ°”è®­ç»ƒå¥—è£…ï¼Œå¸®åŠ©TAåˆ†è¾¨å’–å•¡é‡Œçš„èŒ‰è‰/åšæœ/å·§å…‹åŠ›é£å‘³", tags: ["ä¸“ä¸šè¿›é˜¶", "è¶£å‘³"], match: "å’–å•¡æ¢ç´¢" },
                    { name: "å¤å¤æªç“·æ¯", desc: "æ¬§æ´²è€å¼éœ²è¥æ¯é€ å‹ï¼Œé€‚åˆå¸¦å’–å•¡å»å…¬å›­æˆ–éœ²è¥æ—¶æ‹ç…§", tags: ["æˆ·å¤–", "å¤å¤"], match: "ç”Ÿæ´»æ–¹å¼" }
                ],
                mid: [
                    { name: "Fellow æ¸©æ§å£¶", desc: "é¹…é¢ˆç»†å˜´è®¾è®¡ï¼Œæ¸©æ§ç²¾ç¡®åˆ°1åº¦ï¼Œæ‰‹å†²çˆ±å¥½è€…çš„æ¯•ä¸šè£…å¤‡", tags: ["ä¸“ä¸š", "æ§æ¸©"], match: "å’–å•¡è¿›é˜¶" },
                    { name: "è®¢é˜…åˆ¶å’–å•¡è±†", desc: "æ¯æœˆå¯„é€ä¸åŒäº§åœ°çš„ç²¾å“è±†ï¼Œé™„å¸¦é£å‘³å¡ç‰‡ï¼Œåƒå’–å•¡æ‚å¿—ä¸€æ ·æœŸå¾…æ¯æœˆå¼€ç®±", tags: ["æƒŠå–œæ„Ÿ", "æŒç»­"], match: "å’–å•¡æ¢ç´¢" },
                    { name: "ä¾¿æºå¼æµ“ç¼©å’–å•¡æœº", desc: "ä¸ç”¨ç”µçš„æ‰‹å‹æ„å¼æœºï¼Œéœ²è¥æˆ–å‡ºå·®ä¹Ÿèƒ½å–åˆ°æ²¹è„‚ä¸°å¯Œçš„æµ“ç¼©", tags: ["ä¾¿æº", "æ„å¼"], match: "å’–å•¡åœºæ™¯" }
                ],
                high: [
                    { name: "Decent æ™ºèƒ½å’–å•¡æœº", desc: "èƒ½è®°å½•æ¯æ¯èƒå–æ›²çº¿çš„åŠè‡ªåŠ¨æœºï¼Œè¿æ¥APPåˆ†äº«æ•°æ®ï¼Œå’–å•¡æå®¢çš„æ¢¦æƒ³", tags: ["æ™ºèƒ½", "æ•°æ®æ§"], match: "å’–å•¡æå®¢" },
                    { name: "å®¶ç”¨çƒ˜è±†æœº", desc: "å°å‹çƒ­é£çƒ˜è±†æœºï¼ŒTAå¯ä»¥åœ¨å®¶çƒ˜ç„™ç”Ÿè±†ï¼Œä½“éªŒä»ç”Ÿè±†åˆ°æ¯å­çš„å…¨è¿‡ç¨‹", tags: ["DIY", "æ·±åº¦"], match: "å’–å•¡åˆ¶ä½œ" },
                    { name: "å’–å•¡å¸ˆåŸ¹è®­è¯¾ç¨‹", desc: "SCAè®¤è¯çš„åŸºç¡€è¯¾ç¨‹ï¼Œä»èƒå–åŸç†åˆ°æ‹‰èŠ±æŠ€å·§ï¼Œé€‚åˆæƒ³ç³»ç»Ÿå­¦ä¹ çš„TA", tags: ["æŠ€èƒ½", "ä½“éªŒ"], match: "å’–å•¡å­¦ä¹ " }
                ]
            },
            // ... ï¼ˆå…¶ä»–ç±»åˆ«ä¿æŒä¹‹å‰ä»£ç ä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´ï¼‰
            general: {
                low: [
                    { name: "åˆ›æ„æ—¥å†", desc: "æ¯å¤©ä¸€é¡µå†·çŸ¥è¯†æˆ–æ’ç”»ï¼Œè®©å¹³å‡¡çš„æ—¥å­æœ‰ç‚¹æœŸå¾…", tags: ["æ—¥å¸¸", "æœŸå¾…"], match: "é€šç”¨" },
                    { name: "é¦™è–°èœ¡çƒ›", desc: "å¤§è±†èœ¡+å¤©ç„¶ç²¾æ²¹ï¼Œç¡å‰ç‚¹1å°æ—¶ï¼ŒåŠ©çœ åˆå®‰ç¥", tags: ["åŠ©çœ ", "æ°›å›´"], match: "é€šç”¨" },
                    { name: "å¯çˆ±è¢œå­å¥—è£…", desc: "3åŒä¸åŒå›¾æ¡ˆï¼Œè—åœ¨é‹å­é‡Œçš„å¥½å¿ƒæƒ…ï¼Œå®ç”¨åˆä¿çš®", tags: ["å®ç”¨", "éšè—"], match: "é€šç”¨" }
                ],
                mid: [
                    { name: "è“ç‰™éŸ³ç®±", desc: "ä¾¿æºé˜²æ°´æ¬¾ï¼Œæ´—æ¾¡æˆ–é‡é¤éƒ½èƒ½ç”¨ï¼ŒéŸ³è´¨æ¯”æ‰‹æœºå¥½å¤ªå¤š", tags: ["éŸ³ä¹", "ä¾¿æº"], match: "é€šç”¨" },
                    { name: "ä¿æ¸©æ¯", desc: "è†³é­”å¸ˆæˆ–è™ç‰Œï¼Œä¿æ¸©12å°æ—¶ï¼Œæé†’TAå¤šå–çƒ­æ°´", tags: ["å¥åº·", "è´´å¿ƒ"], match: "é€šç”¨" },
                    { name: "æ¡Œé¢åŠ æ¹¿å™¨", desc: "å†¬å­£ç©ºè°ƒæˆ¿å¿…å¤‡ï¼Œé™éŸ³ä¸æ‰“æ‰°ï¼Œé˜²æ­¢çš®è‚¤å¹²ç‡¥", tags: ["èˆ’é€‚", "å¥åº·"], match: "é€šç”¨" }
                ],
                high: [
                    { name: "AirPods Pro", desc: "é™å™ª+é€šé€æ¨¡å¼ï¼Œé€šå‹¤æˆ–ä¸“æ³¨æ—¶çš„å¿…å¤‡ï¼Œè‹¹æœç”Ÿæ€æ— ç¼", tags: ["é™å™ª", "ç”Ÿæ€"], match: "é€šç”¨ç§‘æŠ€" },
                    { name: "æ™ºèƒ½æ‰‹è¡¨", desc: "å¥åº·ç›‘æµ‹+æ¶ˆæ¯æé†’ï¼Œé€‚åˆå…³å¿ƒå¥åº·çš„TAï¼Œè¿åŠ¨è®°å½•ä¹Ÿå‡†ç¡®", tags: ["å¥åº·", "ä¾¿æ·"], match: "é€šç”¨ç©¿æˆ´" },
                    { name: "å‘¨æœ«åº¦å‡å¥—é¤", desc: "å‘¨è¾¹åŸå¸‚çš„ç²¾å“é…’åº—+æ™šé¤ï¼Œé€ƒç¦»æ—¥å¸¸çš„å°å‡æœŸ", tags: ["æ”¾æ¾", "ä½“éªŒ"], match: "é€šç”¨ä½“éªŒ" }
                ]
            }
        };

        // è¡¥å……å…¶ä»–ç±»åˆ«
        Object.assign(giftDatabase, {
            photography: {
                low: [
                    { name: "èƒ¶ç‰‡ç›¸æœºæ¸…æ´å¥—è£…", desc: "æ°”å¹+é•œå¤´ç¬”+ä¼ æ„Ÿå™¨æ¸…æ´æ£’ï¼Œé€‚åˆåˆšå…¥å‘èƒ¶ç‰‡æ‹…å¿ƒå¼„è„æœºå™¨çš„TA", tags: ["ä¿å…»", "èƒ¶ç‰‡"], match: "æ‘„å½±ç»´æŠ¤" },
                    { name: "å¤å¤ç›¸æœºèƒŒå¸¦", desc: "æ‰‹å·¥ç¼–ç»‡çš„å®½ç‰ˆèƒŒå¸¦ï¼Œå‡å‹è®¾è®¡ï¼Œæ­é…TAçš„å¯Œå£«æˆ–å¾•å¡é¢œå€¼ç¿»å€", tags: ["èˆ’é€‚", "å¤å¤"], match: "æ‘„å½±é…ä»¶" },
                    { name: "æ‰‹æœºå¤–æ¥é•œå¤´", desc: "å¾®è·+å¹¿è§’+é±¼çœ¼ä¸‰åˆä¸€ï¼Œè®©TAå…ˆç”¨æ‰‹æœºç»ƒæ„å›¾", tags: ["æ‰‹æœºæ‘„å½±", "å…¥é—¨"], match: "æ‘„å½±ç»ƒä¹ " }
                ],
                mid: [
                    { name: "æ‹ç«‹å¾—å®½å¹…ç›¸æœº", desc: "æ¯”miniæ›´å¤§çš„ç”»å¹…ï¼Œé€‚åˆæ‹é£æ™¯æˆ–å¤šäººåˆå½±ï¼Œå³æ‹å³å¾—çš„ä»ªå¼æ„Ÿ", tags: ["å³æ—¶æˆåƒ", "ç¤¾äº¤"], match: "æ‘„å½±ä¹è¶£" },
                    { name: "ç…§ç‰‡æ‰“å°æœº", desc: "ä½³èƒ½CP1500ï¼Œæ‰‹æœºç›´è¿æ‰“å°6å¯¸ç…§ç‰‡ï¼Œåšå®ä½“ç›¸å†Œæ¯”å­˜åœ¨æ‰‹æœºé‡Œæ›´æœ‰æ¸©åº¦", tags: ["è¾“å‡º", "å›å¿†"], match: "æ‘„å½±æˆæœ" },
                    { name: "æ‘„å½±ç”»å†Œ", desc: "æ£®å±±å¤§é“æˆ–å·å†…ä¼¦å­çš„æ‘„å½±é›†ï¼Œæ”¾åœ¨åºŠå¤´ç¿»çœ‹çš„å®¡ç¾ç§¯ç´¯", tags: ["å®¡ç¾", "çµæ„Ÿ"], match: "æ‘„å½±å­¦ä¹ " }
                ],
                high: [
                    { name: "ç†å…‰GR3X", desc: "40mmç„¦æ®µçš„è¡—æ‹ç¥æœºï¼Œèƒ½æ”¾è¿›å£è¢‹ï¼Œé€‚åˆå–œæ¬¢éšæ‰‹è®°å½•çš„TA", tags: ["ä¾¿æº", "è¡—æ‹"], match: "æ‘„å½±å™¨æ" },
                    { name: "èƒ¶ç‰‡æ‰«æä»ª", desc: "è‡ªå·±åœ¨å®¶æ‰«æåº•ç‰‡ï¼Œä¿ç•™æ›´å¤šç»†èŠ‚ï¼Œé€‚åˆå¤§é‡æ‹èƒ¶ç‰‡çš„TA", tags: ["èƒ¶ç‰‡", "åæœŸ"], match: "æ‘„å½±æµç¨‹" },
                    { name: "æ‘„å½±å·¥ä½œåŠ", desc: "å‘¨æœ«çš„è¡—å¤´æ‘„å½±è¯¾ç¨‹ï¼Œæœ‰è€å¸ˆå¸¦æ‹å’Œè¯„ç‰‡ï¼Œé€‚åˆæƒ³çªç ´ç“¶é¢ˆçš„TA", tags: ["å­¦ä¹ ", "å®æˆ˜"], match: "æ‘„å½±æå‡" }
                ]
            },
            gaming: {
                low: [
                    { name: "Steamå†·é—¨ç¥ä½œ", desc: "ã€ŠHadesã€‹æˆ–ã€Šæ˜Ÿéœ²è°·ç‰©è¯­ã€‹ç­‰å£ç¢‘æ¸¸æˆï¼Œæ¯”3Aå¤§ä½œæ›´é€‚åˆç¢ç‰‡æ—¶é—´", tags: ["ç‹¬ç«‹æ¸¸æˆ", "è€ç©"], match: "æ¸¸æˆå“å‘³" },
                    { name: "æ‰‹æŸ„ç¡…èƒ¶å¥—", desc: "é˜²æ‰‹æ±—+é˜²æ»‘ï¼Œé•¿æ—¶é—´ç©ä¸å½±å“æ“ä½œï¼Œè¿˜èƒ½ä¿æŠ¤æ‰‹æŸ„ä¸æ³›é»„", tags: ["èˆ’é€‚", "ä¿æŠ¤"], match: "æ¸¸æˆä½“éªŒ" },
                    { name: "æ¸¸æˆåŸå£°é»‘èƒ¶", desc: "ã€Šå¡å°”è¾¾ã€‹æˆ–ã€Šæœ€ç»ˆå¹»æƒ³ã€‹çš„åŸå£°é»‘èƒ¶ï¼Œæ¸¸æˆè¿·çš„æ”¶è—", tags: ["éŸ³ä¹", "æ”¶è—"], match: "æ¸¸æˆæ–‡åŒ–" }
                ],
                mid: [
                    { name: "ç²¾è‹±æ‰‹æŸ„2ä»£", desc: "å¯æ›´æ¢æ‘‡æ†é«˜åº¦å’ŒèƒŒé”®ï¼ŒFPSå’Œæ ¼æ–—æ¸¸æˆçš„æ“ä½œåˆ©å™¨", tags: ["æ“æ§", "ä¸“ä¸š"], match: "æ¸¸æˆè£…å¤‡" },
                    { name: "æ¸¸æˆæ˜¾ç¤ºå™¨æŒ‚ç¯", desc: "å±å¹•ä¸åå…‰ï¼Œæ™šä¸Šç©æ¸¸æˆä¿æŠ¤çœ¼ç›ï¼Œæ— çº¿é¥æ§è°ƒèŠ‚äº®åº¦", tags: ["æŠ¤çœ¼", "æ¡Œé¢"], match: "æ¸¸æˆç¯å¢ƒ" },
                    { name: "åŒäººæˆè¡Œå®ä½“ç‰ˆ", desc: "å¿…é¡»åŒäººåˆä½œçš„ç¥ä½œï¼Œé€‚åˆä½ ä»¬ä¸€èµ·ç©ï¼Œå¢è¿›æ„Ÿæƒ…", tags: ["åˆä½œ", "ç¤¾äº¤"], match: "æ¸¸æˆäº’åŠ¨" }
                ],
                high: [
                    { name: "PS5/Xbox Series X", desc: "æ¬¡ä¸–ä»£ä¸»æœºï¼Œå…‰è¿½ç”»è´¨+æé€ŸåŠ è½½ï¼Œæ¸¸æˆè¿·çš„ç»ˆææ¢¦æƒ³", tags: ["æ¬¡ä¸–ä»£", "æ€§èƒ½"], match: "æ¸¸æˆä¸»æœº" },
                    { name: "ç”µç«æ˜¾ç¤ºå™¨", desc: "2K+144Hz+1mså“åº”ï¼ŒFPSç©å®¶çš„ç‰©ç†å¤–æŒ‚ï¼Œè‰²å½©ä¹Ÿé€‚åˆè®¾è®¡å·¥ä½œ", tags: ["ç«æŠ€", "ç”»è´¨"], match: "æ¸¸æˆæ˜¾ç¤º" },
                    { name: "æ¸¸æˆèˆ±åº§æ¤…", desc: "å¸¦éŸ³å“å’ŒRGBçš„åŠåŒ…å›´åº§æ¤…ï¼Œæ²‰æµ¸å¼æ¸¸æˆä½“éªŒï¼Œç§‘å¹»æ„Ÿå¤–è§‚", tags: ["æ²‰æµ¸", "ç§‘å¹»"], match: "æ¸¸æˆç©ºé—´" }
                ]
            },
            homebody: {
                low: [
                    { name: "é‡åŠ›æ¯¯", desc: "ä½“é‡çš„10%é‡é‡ï¼Œåƒè¢«æ‹¥æŠ±çš„æ„Ÿè§‰ï¼Œæ”¹å–„ç¡çœ è´¨é‡ï¼Œé€‚åˆç„¦è™‘å‹äººæ ¼", tags: ["åŠ©çœ ", "å®‰æŠš"], match: "ç¡çœ æ”¹å–„" },
                    { name: "é¦™è–°æœº+ç²¾æ²¹", desc: "å°¤åŠ åˆ©æˆ–è–°è¡£è‰ç²¾æ²¹ï¼Œè®©æˆ¿é—´æœ‰é«˜çº§é…’åº—çš„å‘³é“ï¼Œå±…å®¶åŠå…¬æ›´æ”¾æ¾", tags: ["æ°›å›´", "æ”¾æ¾"], match: "å±…å®¶ç¯å¢ƒ" },
                    { name: "æ‡’äººæ‰‹æœºæ”¯æ¶", desc: "æŒ‚åœ¨è„–å­ä¸Šçš„å¼¯æ›²æ”¯æ¶ï¼Œèººç€çœ‹è§†é¢‘ä¸ç ¸è„¸ï¼Œç»ˆææ‡’äººç¥å™¨", tags: ["æ‡’äºº", "èˆ’é€‚"], match: "å±…å®¶å§¿åŠ¿" }
                ],
                mid: [
                    { name: "æŠ•å½±ä»ª", desc: "å§å®¤å˜ç§äººå½±é™¢ï¼Œä¾§æŠ•åŠŸèƒ½å°æˆ¿é—´ä¹Ÿèƒ½ç”¨ï¼Œå†¬å¤©çªåœ¨è¢«çªçœ‹ç”µå½±", tags: ["å½±é™¢", "æ¸©æš–"], match: "å±…å®¶å¨±ä¹" },
                    { name: "æ™ºèƒ½çª—å¸˜ç”µæœº", desc: "å®šæ—¶å¼€å…³æˆ–è¯­éŸ³æ§åˆ¶ï¼Œæ—©ä¸Šè‡ªç„¶å…‰å«é†’ï¼Œæ™šä¸Šè‡ªåŠ¨é®å…‰", tags: ["æ™ºèƒ½", "å…‰çº¿"], match: "å±…å®¶æ™ºèƒ½" },
                    { name: "äººä½“å·¥å­¦è…°é ", desc: "è®°å¿†æ£‰+å¯è°ƒèŠ‚é«˜åº¦ï¼Œæ‹¯æ•‘ä¹…åçš„è…°æ¤ï¼Œæ¯”æ¢æ¤…å­åˆ’ç®—", tags: ["å¥åº·", "åŠå…¬"], match: "å±…å®¶åŠå…¬" }
                ],
                high: [
                    { name: "æŒ‰æ‘©æ¤…", desc: "é›¶é‡åŠ›æ¨¡å¼+å…¨èº«æ°”å›Šï¼Œä¸‹ç­å›å®¶çš„15åˆ†é’Ÿå……ç”µç«™", tags: ["æ”¾æ¾", "å…¨èº«"], match: "å±…å®¶äº«å—" },
                    { name: "æ™ºèƒ½åºŠå«", desc: "ç›‘æµ‹ç¡çœ è´¨é‡ï¼Œè‡ªåŠ¨è°ƒèŠ‚è½¯ç¡¬åº¦å’Œæ¸©åº¦ï¼Œç§‘æŠ€æ”¹å–„ç¡çœ ", tags: ["ç¡çœ ", "ç§‘æŠ€"], match: "å±…å®¶å¥åº·" },
                    { name: "å…¨å±‹éŸ³å“ç³»ç»Ÿ", desc: "å„ä¸ªæˆ¿é—´åŒæ­¥æ’­æ”¾ï¼Œåšé¥­æ´—æ¾¡éƒ½æœ‰BGMï¼Œå®…å®¶å¹¸ç¦æ„Ÿçˆ†æ£š", tags: ["éŸ³ä¹", "å…¨å±‹"], match: "å±…å®¶æ°›å›´" }
                ]
            }
        });

        // ==================== åº”ç”¨çŠ¶æ€ ====================
        const store = {
            recipientInfo: null,
            tempOptions: [],
            correctAnswer: null,
            currentRoom: null
        };

        const messages = {
            correct: [
                { title: "é»˜å¥‘æ»¡åˆ†ï¼", desc: "ä½ ä»¬ä¹‹é—´çš„å¿ƒç”µæ„Ÿåº”ä¹Ÿå¤ªå¼ºäº†å§ï¼ğŸ’•" },
                { title: "å¿ƒæœ‰çµçŠ€ï¼", desc: "çœ‹æ¥ä½ çœŸçš„å¾ˆäº†è§£TAå‘¢ï½âœ¨" },
                { title: "çŒœä¸­äº†ï¼", desc: "è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„çµé­‚ä¼´ä¾£å—ï¼ŸğŸ¯" },
                { title: "å¤ªå‰å®³äº†ï¼", desc: "ä½ çš„ç›´è§‰å‡†å¾—å¯æ€•ï¼ğŸ”®" }
            ],
            wrong: [
                { title: "å·®ä¸€ç‚¹ç‚¹ï¼", desc: "çœ‹æ¥æ˜¯ä¸ªæƒŠå–œå‘¢ï¼Œç»§ç»­ä¿æŒç¥ç§˜æ„Ÿï½ğŸ­" },
                { title: "æ²¡çŒœä¸­å“¦ï¼", desc: "çœŸæ­£çš„ç¤¼ç‰©è¿˜åœ¨ç­‰å¾…ç€è¢«æ­æ™“...ğŸ" },
                { title: "ä¸‹æ¬¡ä¸€å®šï¼", desc: "ä¹Ÿè®¸TAæƒ³ç»™ä½ ä¸ªæ„æƒ³ä¸åˆ°çš„æƒŠå–œï¼ŸğŸ’" },
                { title: "æ‚¬å¿µç»§ç»­ï¼", desc: "ä¿æŒæœŸå¾…ï¼ŒçœŸæ­£çš„ç¤¼ç‰©æ›´æ£’å“¦ï¼âœ¨" }
            ]
        };

        // ==================== AI é€»è¾‘ï¼ˆä¿æŒä¹‹å‰ï¼‰====================
        function analyzeInput(info) {
            const analysis = {
                categories: [],
                specificTags: [],
                priceLevel: 'mid',
                scenario: info.occasion,
                relation: info.relation
            };

            const text = (info.hobby + ' ' + info.extra).toLowerCase();
            const age = parseInt(info.age) || 25;

            if (/å’–å•¡|æ‰‹å†²|æ„å¼|å’–å•¡è±†|æ‹‰èŠ±|å’–å•¡é¦†/.test(text)) analysis.categories.push('coffee');
            if (/æ‹ç…§|æ‘„å½±|ç›¸æœº|é•œå¤´|èƒ¶ç‰‡|å•å|å¾•å¡|å¯Œå£«/.test(text)) analysis.categories.push('photography');
            if (/æ¸¸æˆ|ç”µç«|switch|ps5|xbox|steam|ç‹è€…|åŸç¥|å¡å°”è¾¾/.test(text)) analysis.categories.push('gaming');
            if (/å®…|å±…å®¶|åœ¨å®¶|æ²™å‘|åºŠ|ç¡è§‰/.test(text)) analysis.categories.push('homebody');

            if (analysis.categories.length === 0) {
                if (age < 25) analysis.categories.push('gaming', 'photography');
                else if (age < 35) analysis.categories.push('coffee', 'homebody');
                else analysis.categories.push('homebody', 'coffee');
                
                if (info.relation === 'æ‹äºº') analysis.categories.push('coffee');
                else if (info.relation === 'å®¶äºº') analysis.categories.push('homebody');
            }

            if (/æ–°æ‰‹|å…¥é—¨|åˆšå¼€å§‹|å°ç™½/.test(text)) analysis.specificTags.push('å…¥é—¨å‹å¥½');
            if (/ä¸“ä¸š|è¿›é˜¶|æ·±åº¦|å‘çƒ§/.test(text)) analysis.specificTags.push('ä¸“ä¸šçº§');
            if (/é¢œå€¼|å¥½çœ‹|æ‹ç…§|insé£/.test(text)) analysis.specificTags.push('é«˜é¢œå€¼');

            const avgBudget = (parseInt(info.budgetMin) + parseInt(info.budgetMax)) / 2;
            if (avgBudget < 150) analysis.priceLevel = 'low';
            else if (avgBudget > 1000) analysis.priceLevel = 'high';
            else analysis.priceLevel = 'mid';

            return analysis;
        }

        function generatePersonalizedOptions(info) {
            const analysis = analyzeInput(info);
            const options = [];
            const usedNames = new Set();

            const primaryCats = analysis.categories.slice(0, 2);
            primaryCats.forEach(cat => {
                const db = giftDatabase[cat] || giftDatabase.general;
                const level = db[analysis.priceLevel] || db.mid;
                let candidates = level.filter(item => !usedNames.has(item.name));
                
                if (analysis.specificTags.includes('å…¥é—¨å‹å¥½')) {
                    candidates = candidates.filter(c => c.tags.includes('å…¥é—¨') || c.tags.includes('åŸºç¡€'));
                }

                if (candidates.length > 0) {
                    const selected = candidates[Math.floor(Math.random() * candidates.length)];
                    options.push({
                        ...selected,
                        reason: `æ ¹æ®${cat}çˆ±å¥½æ¨è${analysis.specificTags.length > 0 ? 'ï¼Œå¥‘åˆ' + analysis.specificTags[0] : ''}`,
                        matchScore: 98,
                        category: cat
                    });
                    usedNames.add(selected.name);
                }
            });

            while (options.length < 3) {
                const allCats = Object.keys(giftDatabase).filter(c => c !== 'general');
                const randomCat = allCats[Math.floor(Math.random() * allCats.length)];
                const db = giftDatabase[randomCat];
                const level = db[analysis.priceLevel] || db.mid;
                const available = level.filter(item => !usedNames.has(item.name));
                
                if (available.length > 0) {
                    const selected = available[Math.floor(Math.random() * available.length)];
                    options.push({
                        ...selected,
                        reason: "ç»¼åˆTAçš„å…´è¶£å›¾è°±æ¨è",
                        matchScore: 88,
                        category: randomCat
                    });
                    usedNames.add(selected.name);
                }
            }

            return options.slice(0, 3).map(opt => ({
                ...opt,
                priceTag: `Â¥${info.budgetMin}-${info.budgetMax}æ¡£`,
                tags: [...opt.tags, ...analysis.specificTags.slice(0, 1), analysis.priceLevel === 'low' ? 'é«˜æ€§ä»·æ¯”' : analysis.priceLevel === 'high' ? 'å“è´¨ä¹‹é€‰' : 'å®ç”¨ä¸»ä¹‰']
            }));
        }

        function regenerateWithFeedback(idx, feedback, currentInfo) {
            const analysis = analyzeInput(currentInfo);
            
            if (feedback === 'å¤ªè´µ') {
                analysis.priceLevel = analysis.priceLevel === 'high' ? 'mid' : 'low';
            } else if (feedback === 'å¤ªä¾¿å®œ') {
                analysis.priceLevel = analysis.priceLevel === 'low' ? 'mid' : 'high';
            } else if (feedback === 'TAæœ‰äº†') {
                const cat = analysis.categories[0];
                const alternatives = Object.keys(giftDatabase).filter(c => c !== cat && c !== 'general');
                analysis.categories = [alternatives[Math.floor(Math.random() * alternatives.length)]];
            }

            const cat = analysis.categories[0];
            const db = giftDatabase[cat] || giftDatabase.general;
            const level = db[analysis.priceLevel] || db.mid;
            const selected = level[Math.floor(Math.random() * level.length)];
            
            return {
                ...selected,
                reason: `æ ¹æ®"${feedback}"è°ƒæ•´åæ¨è`,
                matchScore: 96,
                priceTag: `Â¥${currentInfo.budgetMin}-${currentInfo.budgetMax}æ¡£`,
                tags: [...selected.tags, 'ç²¾å‡†è°ƒæ•´', analysis.priceLevel === 'low' ? 'é«˜æ€§ä»·æ¯”' : analysis.priceLevel === 'high' ? 'å“è´¨ä¹‹é€‰' : 'å®ç”¨ä¸»ä¹‰']
            };
        }

        // ==================== UI å‡½æ•° ====================
        window.onload = function() {
            showHome();
            initParallax();
            checkUrlParams();
        };

        function initParallax() {
            document.addEventListener('scroll', () => {
                const scrolled = window.pageYOffset;
                document.querySelectorAll('.parallax-bg').forEach(el => {
                    const speed = el.getAttribute('data-speed');
                    el.style.transform = `translateY(${scrolled * speed}px)`;
                });
            });
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function showHome() {
            const html = `
                <div class="space-y-6 animate-fade-in">
                    <div onclick="showCreateRoom()" class="hand-drawn bg-white p-6 cursor-pointer btn-press float-anim relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-pink-200 rounded-full -mr-16 -mt-16 opacity-50 group-hover:scale-110 transition-transform"></div>
                        <div class="relative z-10">
                            <div class="text-4xl mb-2">ğŸ</div>
                            <h2 class="text-2xl font-black text-gray-800 mb-1">åˆ›å»ºç›²ç›’æˆ¿é—´</h2>
                            <p class="text-gray-600 text-sm">ä¸ºTAå‡†å¤‡ä¸€ä»½ç¥ç§˜ç¤¼ç‰©ï¼Œè®©TAæ¥çŒœ</p>
                        </div>
                        <div class="absolute bottom-4 right-4 text-2xl star">âœ¨</div>
                    </div>

                    <div class="hand-drawn-blue bg-white p-6 float-anim-delayed">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span>ğŸ”‘</span> è¾“å…¥æˆ¿é—´ç 
                        </h3>
                        <div class="flex justify-center mb-4" id="code-inputs">
                            ${[0,1,2,3,4,5].map(i => `
                                <input type="text" class="code-input" maxlength="1" oninput="handleCodeInput(this, ${i})" onkeydown="handleCodeKeydown(event, ${i})">
                            `).join('')}
                        </div>
                        <button onclick="enterRoom()" class="w-full bg-gradient-to-r from-blue-400 to-blue-500 text-white font-bold py-3 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press">
                            è¿›å…¥æˆ¿é—´ ğŸšª
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('bottom-nav').classList.add('hidden');
        }

        function handleCodeInput(input, index) {
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value && index < 5) {
                document.querySelectorAll('.code-input')[index + 1].focus();
            }
        }

        function handleCodeKeydown(e, index) {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                document.querySelectorAll('.code-input')[index - 1].focus();
            }
        }

        function showCreateRoom() {
            const html = `
                <div class="animate-fade-in">
                    <button onclick="showHome()" class="mb-4 text-gray-600 hover:text-pink-500 font-bold flex items-center gap-1">
                        â† è¿”å›é¦–é¡µ
                    </button>
                    
                    <div class="hand-drawn bg-white p-6 mb-6">
                        <h2 class="text-2xl font-black mb-6 flex items-center gap-2">
                            <span class="text-3xl">ğŸ“</span> æ”¶ç¤¼äººä¿¡æ¯
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block font-bold mb-2 text-sm">åŸºç¡€ä¿¡æ¯ <span class="text-pink-500">*</span></label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="recipient-age" placeholder="å¹´é¾„" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-pink-400 focus:outline-none">
                                    <select id="recipient-gender" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-pink-400 focus:outline-none bg-white">
                                        <option value="">æ€§åˆ«</option>
                                        <option value="ç”·">ç”·</option>
                                        <option value="å¥³">å¥³</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                </div>
                                <select id="recipient-relation" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-pink-400 focus:outline-none bg-white mt-2">
                                    <option value="">å…³ç³»</option>
                                    <option value="æ‹äºº">æ‹äºº ğŸ’•</option>
                                    <option value="å¥½å‹">å¥½å‹ ğŸ‘¯</option>
                                    <option value="å®¶äºº">å®¶äºº ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</option>
                                    <option value="åŒäº‹">åŒäº‹ ğŸ’¼</option>
                                </select>
                            </div>

                            <div>
                                <label class="block font-bold mb-2 text-sm">å…´è¶£çˆ±å¥½ <span class="text-pink-500">*</span> <span class="text-xs text-gray-400 font-normal">è¶Šè¯¦ç»†è¶Šç²¾å‡†</span></label>
                                <textarea id="recipient-hobby" placeholder="æ¯”å¦‚ï¼šå–œæ¬¢æ‰‹å†²å’–å•¡ä½†æ‹‰èŠ±æ€»å¤±è´¥ã€åˆšå…¥å‘èƒ¶ç‰‡æ‘„å½±ã€å‘¨æœ«å–œæ¬¢å®…å®¶çœ‹æ‚¬ç–‘å‰§..." class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-pink-400 focus:outline-none h-24 resize-none"></textarea>
                            </div>

                            <div>
                                <label class="block font-bold mb-2 text-sm">é€ç¤¼åœºæ™¯ <span class="text-pink-500">*</span></label>
                                <select id="recipient-occasion" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-pink-400 focus:outline-none bg-white">
                                    <option value="">é€‰æ‹©åœºåˆ</option>
                                    <option value="birthday">ç”Ÿæ—¥ ğŸ‚</option>
                                    <option value="anniversary">çºªå¿µæ—¥ ğŸ’</option>
                                    <option value="festival">èŠ‚æ—¥ ğŸ„</option>
                                    <option value="daily">æ—¥å¸¸æƒŠå–œ âœ¨</option>
                                </select>
                            </div>

                            <div>
                                <label class="block font-bold mb-2 text-sm">é¢„ç®—åŒºé—´ <span class="text-pink-500">*</span></label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="budget-min" placeholder="æœ€ä½ Â¥" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-pink-400 focus:outline-none">
                                    <input type="number" id="budget-max" placeholder="æœ€é«˜ Â¥" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-pink-400 focus:outline-none">
                                </div>
                            </div>

                            <div>
                                <label class="block font-bold mb-2 text-sm">å…¶ä»–ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰</label>
                                <textarea id="recipient-extra" placeholder="æ¯”å¦‚ï¼šæœ€è¿‘åŠ ç­å¾ˆå¤šé¢ˆæ¤ä¸å¥½/æç®€ä¸»ä¹‰è€…è®¨åŒå¤šä½™åŒ…è£…..." class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-pink-400 focus:outline-none h-20 resize-none"></textarea>
                            </div>
                        </div>

                        <button onclick="generateOptions()" class="w-full mt-6 bg-gradient-to-r from-pink-400 to-pink-500 text-white font-bold py-4 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press text-lg">
                            AIç”Ÿæˆä¸“å±æ¨è âœ¨
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function generateOptions() {
            const age = document.getElementById('recipient-age').value;
            const relation = document.getElementById('recipient-relation').value;
            const hobby = document.getElementById('recipient-hobby').value;
            const occasion = document.getElementById('recipient-occasion').value;
            const budgetMin = document.getElementById('budget-min').value;
            const budgetMax = document.getElementById('budget-max').value;

            if (!age || !relation || !hobby || !occasion || !budgetMin || !budgetMax) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹å“¦ï½');
                return;
            }

            store.recipientInfo = {
                age, relation, hobby, occasion, budgetMin, budgetMax,
                extra: document.getElementById('recipient-extra').value,
                gender: document.getElementById('recipient-gender').value
            };

            const html = `
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="flex gap-2 mb-4">
                        <div class="w-4 h-4 bg-pink-400 rounded-full loading-dot"></div>
                        <div class="w-4 h-4 bg-blue-400 rounded-full loading-dot"></div>
                        <div class="w-4 h-4 bg-yellow-400 rounded-full loading-dot"></div>
                    </div>
                    <p class="font-bold text-gray-600">AIæ­£åœ¨æ·±åº¦åˆ†æ...</p>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;

            setTimeout(() => {
                store.tempOptions = generatePersonalizedOptions(store.recipientInfo);
                showOptionsReview();
            }, 1500);
        }

        function showOptionsReview() {
            const html = `
                <div class="animate-fade-in">
                    <button onclick="showCreateRoom()" class="mb-4 text-gray-600 hover:text-pink-500 font-bold flex items-center gap-1">
                        â† é‡æ–°å¡«å†™
                    </button>
                    
                    <div class="hand-drawn bg-white p-6 mb-6">
                        <h2 class="text-2xl font-black mb-2">ğŸ¯ ä¸“å±æ¨è</h2>
                        <p class="text-gray-500 text-sm mb-6">åŸºäº"${store.recipientInfo.hobby.substring(0, 20)}..."</p>

                        <div class="space-y-4 mb-6">
                            ${store.tempOptions.map((opt, idx) => `
                                <div class="option-card hand-drawn-pink bg-gradient-to-br from-pink-50 to-white p-4" id="ai-option-${idx}">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <span class="tag-pill price-tag text-xs">${opt.priceTag}</span>
                                            <span class="tag-pill match-tag text-xs">${opt.matchScore}%åŒ¹é…</span>
                                            <h3 class="font-bold text-lg mt-1">${opt.name}</h3>
                                        </div>
                                        <button onclick="removeOption(${idx})" class="text-red-400 hover:text-red-600 font-bold text-xl">Ã—</button>
                                    </div>
                                    <p class="text-gray-600 text-sm mb-2">${opt.desc}</p>
                                    <div class="flex flex-wrap gap-1 mb-2">
                                        ${opt.tags.map(tag => `<span class="tag-pill feature-tag text-xs">${tag}</span>`).join('')}
                                    </div>
                                    <button onclick="showFeedback(${idx})" class="text-xs text-pink-500 font-bold">æ¢ä¸€æ¢ ğŸ”„</button>
                                    <div id="feedback-${idx}" class="hidden mt-2 pt-2 border-t border-pink-200">
                                        <div class="flex flex-wrap gap-2">
                                            ${['å¤ªè´µ', 'å¤ªä¾¿å®œ', 'TAæœ‰äº†', 'ä¸ç¬¦åˆæ°”è´¨'].map(fb => `
                                                <span onclick="handleFeedback(${idx}, '${fb}')" class="feedback-tag bg-white border-2 border-gray-300 px-2 py-1 rounded-full text-xs">${fb}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="hand-drawn-blue bg-blue-50 p-4 mb-6">
                            <h3 class="font-bold mb-2">âœï¸ æ·»åŠ ä½ çš„ç¤¼ç‰©ï¼ˆå¯é€‰ï¼‰</h3>
                            <input type="text" id="my-gift-name" placeholder="ç¤¼ç‰©åç§°" class="w-full p-2 border-2 rounded-xl mb-2">
                            <textarea id="my-gift-desc" placeholder="æè¿°..." class="w-full p-2 border-2 rounded-xl h-16 mb-2"></textarea>
                            <button onclick="addMyGift()" class="w-full bg-blue-400 text-white font-bold py-2 rounded-xl btn-press">åŠ å…¥ â•</button>
                        </div>

                        <button onclick="confirmOptions()" class="w-full bg-gradient-to-r from-pink-400 to-pink-500 text-white font-bold py-4 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press text-lg">
                            ç”Ÿæˆæˆ¿é—´ ğŸ‰
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function showFeedback(idx) {
            document.getElementById(`feedback-${idx}`).classList.toggle('hidden');
        }

        function handleFeedback(idx, feedback) {
            const newOption = regenerateWithFeedback(idx, feedback, store.recipientInfo);
            store.tempOptions[idx] = newOption;
            showOptionsReview();
        }

        function removeOption(idx) {
            if (store.tempOptions.length <= 1) {
                alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªé€‰é¡¹');
                return;
            }
            store.tempOptions.splice(idx, 1);
            showOptionsReview();
        }

        function addMyGift() {
            const name = document.getElementById('my-gift-name').value;
            const desc = document.getElementById('my-gift-desc').value;
            if (!name) return alert('è¯·è¾“å…¥åç§°');
            
            store.tempOptions.push({
                name, desc: desc || 'ç‰¹åˆ«çš„å¿ƒæ„',
                tags: ['ä½ çš„å¿ƒæ„'], isCustom: true,
                priceTag: 'ä¸“å±', matchScore: 100,
                reason: 'ä½ æŒ‘é€‰çš„'
            });
            store.correctAnswer = name;
            showOptionsReview();
        }

        async function confirmOptions() {
            if (store.tempOptions.length < 4) {
                if (confirm(`åªæœ‰${store.tempOptions.length}ä¸ªï¼ŒAIå†ç”Ÿæˆ${4-store.tempOptions.length}ä¸ªï¼Ÿ`)) {
                    while (store.tempOptions.length < 4) {
                        const extra = generatePersonalizedOptions(store.recipientInfo)[0];
                        if (!store.tempOptions.find(o => o.name === extra.name)) {
                            store.tempOptions.push(extra);
                        }
                    }
                } else return;
            }

            const roomCode = Math.floor(100000 + Math.random() * 900000).toString();
            if (!store.correctAnswer) {
                store.correctAnswer = store.tempOptions[Math.floor(Math.random() * store.tempOptions.length)].name;
            }

            const room = {
                code: roomCode,
                options: [...store.tempOptions],
                correctAnswer: store.correctAnswer,
                recipientInfo: store.recipientInfo,
                createdAt: Date.now(),
                status: 'active',
                guesses: [],
                creatorId: localStorage.getItem('deviceId') || generateDeviceId()
            };

            // ä¿å­˜åˆ°äº‘ç«¯
            await DataStore.saveRoom(room);
            showRoomCreated(roomCode);
        }

        function generateDeviceId() {
            const id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', id);
            return id;
        }

        function showRoomCreated(code) {
            const shareText = `æˆ‘ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ªç¥ç§˜ç¤¼ç‰©ç›²ç›’ï¼å¿«æ¥çŒœçŒœæˆ‘è¦é€ä½ ä»€ä¹ˆï½ æˆ¿é—´ç ï¼š${code}`;
            const shareUrl = `${window.location.origin}${window.location.pathname}?room=${code}`;
            
            const html = `
                <div class="animate-fade-in text-center py-8">
                    <div class="text-6xl mb-4 result-pop">ğŸ‰</div>
                    <h2 class="text-2xl font-black mb-2">æˆ¿é—´åˆ›å»ºæˆåŠŸï¼</h2>
                    
                    <div class="hand-drawn bg-white p-6 mb-6 w-full">
                        <p class="text-gray-500 text-sm mb-2">æˆ¿é—´ç </p>
                        <div class="text-5xl font-black text-pink-500 tracking-widest mb-4" style="font-family: monospace;">${code}</div>
                        <div class="bg-gray-50 p-3 rounded-lg text-left">
                            <p class="text-xs text-gray-400">åˆ†äº«æ–‡æ¡ˆï¼š</p>
                            <p class="text-sm text-gray-600">${shareText}</p>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button onclick="shareToWeChat('${code}', '${shareText}')" class="share-btn w-full bg-green-500 text-white font-bold py-3 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press">
                            ğŸ’¬ åˆ†äº«åˆ°å¾®ä¿¡
                        </button>
                        <button onclick="copyLink('${shareUrl}', '${shareText}')" class="share-btn w-full bg-blue-500 text-white font-bold py-3 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press">
                            ğŸ”— å¤åˆ¶é“¾æ¥
                        </button>
                        <button onclick="copyCode('${code}')" class="share-btn w-full bg-white text-gray-800 font-bold py-3 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press">
                            ğŸ“‹ å¤åˆ¶æˆ¿é—´ç 
                        </button>
                        <button onclick="showMyRooms()" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-2xl border-2 border-gray-300 btn-press">
                            æˆ‘çš„æˆ¿é—´ ğŸ 
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
            copyToClipboard(shareText);
        }

        function shareToWeChat(code, text) {
            if (navigator.share) {
                navigator.share({ title: 'å¿ƒæ„ç›²ç›’', text: text, url: window.location.href })
                    .catch(() => { copyToClipboard(text); showToast('å·²å¤åˆ¶ï¼Œå»å¾®ä¿¡ç²˜è´´'); });
            } else {
                copyToClipboard(text);
                showToast('å·²å¤åˆ¶ï¼Œå»å¾®ä¿¡ç²˜è´´');
            }
        }

        function copyLink(url, text) {
            copyToClipboard(`${text} ${url}`);
            showToast('é“¾æ¥å·²å¤åˆ¶ï¼');
        }

        function copyCode(code) {
            copyToClipboard(code);
            showToast('æˆ¿é—´ç å·²å¤åˆ¶ï¼');
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
            } else {
                const input = document.createElement('input');
                input.value = text;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
            }
        }

        // ==================== æ ¸å¿ƒï¼šè¿›å…¥æˆ¿é—´ï¼ˆè”æœºï¼‰====================
        async function enterRoom() {
            const inputs = document.querySelectorAll('.code-input');
            const code = Array.from(inputs).map(i => i.value).join('');
            
            if (code.length !== 6) {
                alert('è¯·è¾“å…¥å®Œæ•´çš„6ä½æˆ¿é—´ç ');
                return;
            }

            showToast('æ­£åœ¨è¿æ¥æˆ¿é—´...');
            
            // ä»äº‘ç«¯è·å–æˆ¿é—´
            const room = await DataStore.getRoom(code);
            
            if (!room) {
                alert('æˆ¿é—´ä¸å­˜åœ¨æˆ–å·²å…³é—­ï¼Œæ£€æŸ¥æˆ¿é—´ç æ˜¯å¦æ­£ç¡®');
                return;
            }

            if (room.status === 'closed') {
                showClosedPage();
                return;
            }

            store.currentRoom = room;
            
            // å¼€å§‹å®æ—¶ç›‘å¬æˆ¿é—´å˜åŒ–
            DataStore.listenToRoom(code, (updatedRoom) => {
                if (updatedRoom) {
                    store.currentRoom = updatedRoom;
                    // å¦‚æœåœ¨æˆ¿é—´é¡µé¢ï¼Œå¯ä»¥å®æ—¶æ›´æ–°çŒœæµ‹åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
                }
            });
            
            showGuessPage(room);
        }

        function showGuessPage(room) {
            const shuffledOptions = [...room.options].sort(() => 0.5 - Math.random());
            
            const html = `
                <div class="animate-fade-in">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-2">ğŸ</div>
                        <h2 class="text-xl font-black">çŒœçŒœå“ªä¸ªæ˜¯TAè¦é€çš„ç¤¼ç‰©ï¼Ÿ</h2>
                        <p class="text-gray-500 text-sm mt-1">æˆ¿é—´ç ï¼š${room.code}</p>
                    </div>

                    <div class="space-y-3 mb-6" id="guess-options">
                        ${shuffledOptions.map((opt, idx) => `
                            <div class="option-card hand-drawn bg-white p-4" onclick="selectOption(this, '${opt.name}')" data-name="${opt.name}">
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0 mt-1 option-circle">
                                        <div class="w-4 h-4 rounded-full bg-pink-400 opacity-0 transition-opacity"></div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                                            <h3 class="font-bold text-lg">${opt.name}</h3>
                                            ${opt.priceTag ? `<span class="tag-pill price-tag text-xs">${opt.priceTag}</span>` : ''}
                                        </div>
                                        <p class="text-gray-600 text-sm leading-relaxed mb-2">${opt.desc}</p>
                                        ${opt.tags ? `<div class="flex flex-wrap gap-1">${opt.tags.slice(0,3).map(t => `<span class="tag-pill feature-tag text-xs">${t}</span>`).join('')}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button id="confirm-guess" onclick="submitGuess()" class="w-full bg-gray-300 text-white font-bold py-4 rounded-2xl border-2 border-gray-400 cursor-not-allowed" disabled>
                        å…ˆé€‰ä¸€ä¸ªé€‰é¡¹ ğŸ‘†
                    </button>
                    
                    ${room.guesses && room.guesses.length > 0 ? `
                    <div class="mt-6 p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
                        <p class="text-sm text-blue-600 font-bold mb-2">å·²æœ‰ ${room.guesses.length} äººå‚ä¸çŒœæµ‹</p>
                        <p class="text-xs text-blue-400">å¿«æ¥åŠ å…¥å§ï¼</p>
                    </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('bottom-nav').classList.remove('hidden');
        }

        let selectedOption = null;
        function selectOption(el, name) {
            document.querySelectorAll('.option-card').forEach(c => {
                c.classList.remove('selected');
                c.querySelector('.option-circle div').classList.add('opacity-0');
            });
            el.classList.add('selected');
            el.querySelector('.option-circle div').classList.remove('opacity-0');
            selectedOption = name;
            
            const btn = document.getElementById('confirm-guess');
            btn.disabled = false;
            btn.classList.remove('bg-gray-300', 'border-gray-400', 'cursor-not-allowed');
            btn.classList.add('bg-gradient-to-r', 'from-pink-400', 'to-pink-500', 'border-gray-800', 'btn-press', 'shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]');
            btn.textContent = 'ç¡®è®¤é€‰æ‹© ğŸ¯';
        }

        async function submitGuess() {
            if (!selectedOption || !store.currentRoom) return;
            
            const isCorrect = selectedOption === store.currentRoom.correctAnswer;
            const msgList = isCorrect ? messages.correct : messages.wrong;
            const msg = msgList[Math.floor(Math.random() * msgList.length)];
            
            // ä¿å­˜çŒœæµ‹åˆ°äº‘ç«¯
            await DataStore.addGuess(store.currentRoom.code, {
                option: selectedOption,
                isCorrect: isCorrect,
                deviceId: localStorage.getItem('deviceId') || 'anonymous'
            });

            const html = `
                <div class="animate-fade-in text-center py-10">
                    <div class="text-6xl mb-4 result-pop">${isCorrect ? 'ğŸ‰' : 'ğŸ˜‰'}</div>
                    <h2 class="text-3xl font-black mb-2 ${isCorrect ? 'text-pink-500' : 'text-blue-500'}">${msg.title}</h2>
                    <p class="text-gray-600 mb-8 text-lg">${msg.desc}</p>
                    
                    <div class="hand-drawn bg-white p-6 mb-6">
                        <p class="text-gray-500 text-sm mb-2">ä½ é€‰æ‹©äº†</p>
                        <p class="font-bold text-xl">${selectedOption}</p>
                        ${isCorrect ? '<div class="mt-2 text-pink-500 font-bold">âœ“ çŒœå¯¹äº†ï¼</div>' : '<div class="mt-2 text-blue-500 font-bold">âœ— æ²¡çŒœä¸­</div>'}
                    </div>

                    <div class="space-y-3">
                        <button onclick="showCreateRoom()" class="w-full bg-gradient-to-r from-pink-400 to-pink-500 text-white font-bold py-3 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press">
                            æˆ‘ä¹Ÿåˆ›å»ºä¸€ä¸ª âœ¨
                        </button>
                        <button onclick="showHome()" class="w-full bg-white text-gray-800 font-bold py-3 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press">
                            è¿”å›é¦–é¡µ ğŸ 
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        async function showMyRooms() {
            const rooms = await DataStore.getMyRooms();
            const myDeviceId = localStorage.getItem('deviceId');
            
            // è¿‡æ»¤å‡ºæˆ‘åˆ›å»ºçš„æˆ¿é—´
            const myRooms = rooms.filter(r => r.creatorId === myDeviceId);
            
            const html = `
                <div class="animate-fade-in">
                    <button onclick="showHome()" class="mb-4 text-gray-600 hover:text-pink-500 font-bold flex items-center gap-1">
                        â† è¿”å›é¦–é¡µ
                    </button>
                    
                    <h2 class="text-2xl font-black mb-6 flex items-center gap-2">
                        <span class="text-3xl">ğŸ</span> æˆ‘çš„æˆ¿é—´ (${myRooms.length})
                    </h2>

                    ${myRooms.length === 0 ? `
                        <div class="text-center py-10 text-gray-400">
                            <div class="text-4xl mb-2">ğŸ“­</div>
                            <p>è¿˜æ²¡æœ‰åˆ›å»ºæˆ¿é—´</p>
                            <button onclick="showCreateRoom()" class="mt-4 text-pink-500 font-bold underline">ç«‹å³åˆ›å»º</button>
                        </div>
                    ` : `
                        <div class="space-y-4">
                            ${myRooms.map(room => {
                                const guessCount = room.guesses ? room.guesses.length : 0;
                                const correctCount = room.guesses ? room.guesses.filter(g => g.isCorrect).length : 0;
                                return `
                                    <div class="hand-drawn bg-white p-4 relative ${room.status === 'closed' ? 'opacity-50' : ''}">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <span class="text-2xl font-black text-pink-500" style="font-family: monospace;">${room.code}</span>
                                                ${room.status === 'closed' ? 
                                                    '<span class="text-xs bg-gray-400 text-white px-2 py-1 rounded-full ml-2">å·²å…³é—­</span>' : 
                                                    '<span class="text-xs bg-green-400 text-white px-2 py-1 rounded-full ml-2">è¿›è¡Œä¸­</span>'
                                                }
                                            </div>
                                            <button onclick="toggleRoomStatus('${room.code}')" class="text-gray-400 hover:text-red-500 text-xl">
                                                ${room.status === 'active' ? 'ğŸ”’' : 'ğŸ”“'}
                                            </button>
                                        </div>
                                        
                                        <div class="text-sm text-gray-600 mb-2">
                                            <p>çŒœæµ‹ï¼š${guessCount} æ¬¡ | çŒœä¸­ï¼š${correctCount} æ¬¡</p>
                                            <p class="text-xs text-gray-400">${new Date(room.createdAt).toLocaleDateString()}</p>
                                        </div>
                                        
                                        ${guessCount > 0 ? `
                                            <div class="border-t-2 border-pink-100 pt-2 mt-2">
                                                <p class="text-xs font-bold text-gray-500 mb-1">æœ€è¿‘çŒœæµ‹ï¼š</p>
                                                ${room.guesses.slice(-2).map(g => `
                                                    <div class="flex justify-between text-xs">
                                                        <span class="truncate flex-1">${g.option}</span>
                                                        <span class="${g.isCorrect ? 'text-pink-500' : 'text-blue-500'} font-bold">
                                                            ${g.isCorrect ? 'âœ“' : 'âœ—'}
                                                        </span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : '<p class="text-xs text-gray-400 italic">æš‚æ— äººçŒœæµ‹</p>'}
                                        
                                        ${room.status === 'active' ? `
                                        <button onclick="showRoomCreated('${room.code}')" class="mt-3 w-full bg-pink-100 text-pink-600 font-bold py-2 rounded-lg text-sm border-2 border-pink-300 btn-press">
                                            åˆ†äº«æˆ¿é—´ ğŸ”—
                                        </button>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('bottom-nav').classList.remove('hidden');
        }

        async function toggleRoomStatus(code) {
            await DataStore.toggleRoomStatus(code);
            showMyRooms();
        }

        function showClosedPage() {
            const html = `
                <div class="animate-fade-in text-center py-20">
                    <div class="text-6xl mb-4 float-anim">ğŸ™ˆ</div>
                    <h2 class="text-2xl font-black mb-2">æ¥æ™šå•¦ï½</h2>
                    <p class="text-gray-600 mb-6">è¿™ä¸ªæˆ¿é—´å·²ç»è¢«ä¸»äººå…³é—­äº†</p>
                    <button onclick="showHome()" class="bg-gradient-to-r from-pink-400 to-pink-500 text-white font-bold py-3 px-8 rounded-2xl border-2 border-gray-800 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] btn-press">
                        è¿”å›é¦–é¡µ ğŸ 
                    </button>
                </div>
            `;
            document.getElementById('main-content').innerHTML = html;
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const roomCode = params.get('room');
            if (roomCode && roomCode.length === 6) {
                setTimeout(async () => {
                    // è‡ªåŠ¨è¿›å…¥æˆ¿é—´
                    const room = await DataStore.getRoom(roomCode);
                    if (room && room.status === 'active') {
                        store.currentRoom = room;
                        DataStore.listenToRoom(roomCode, (r) => { if(r) store.currentRoom = r; });
                        showGuessPage(room);
                        showToast('å·²é€šè¿‡é“¾æ¥è¿›å…¥æˆ¿é—´');
                    } else if (room && room.status === 'closed') {
                        showClosedPage();
                    } else {
                        showToast('æˆ¿é—´ä¸å­˜åœ¨');
                    }
                    // æ¸…é™¤URLå‚æ•°
                    window.history.replaceState({}, document.title, window.location.pathname);
                }, 500);
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            .animate-fade-in { animation: fadeIn 0.5s ease-out; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>